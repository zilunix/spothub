name: Build & Deploy Frontend to Dev

on:
  workflow_dispatch:   # запуск только по кнопке

jobs:
  build-and-deploy-dev:
    runs-on: [self-hosted, spothub-1]

    env:
      IMAGE_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/full-mvp-frontend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Docker login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Compute image tag
        id: vars
        run: |
          SHA="${GITHUB_SHA}"
          echo "Using SHA: ${SHA}"
          echo "tag=dev-${SHA}" >> "$GITHUB_OUTPUT"

      - name: Build frontend image
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          IMAGE="${IMAGE_REPO}:${TAG}"
          echo "Building image ${IMAGE}..."
          # если Dockerfile фронта лежит НЕ в ./frontend, поправь путь
          docker build -t "${IMAGE}" ./frontend

      - name: Push frontend image
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          IMAGE="${IMAGE_REPO}:${TAG}"
          echo "Pushing image ${IMAGE}..."
          docker push "${IMAGE}"

      - name: Deploy frontend to DEV namespace
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          IMAGE="${IMAGE_REPO}:${TAG}"
          echo "Deploying ${IMAGE} to sporthub-dev..."
          kubectl -n sporthub-dev set image deployment/sporthub-frontend frontend="${IMAGE}"
          kubectl -n sporthub-dev rollout status deployment/sporthub-frontend
