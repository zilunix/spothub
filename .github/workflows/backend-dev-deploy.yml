name: Build & Deploy Backend to Dev
run-name: "Build & Deploy Backend to Dev Ц ${{ github.event.inputs.title || github.sha }}"

on:
  workflow_dispatch:
    inputs:
      title:
        description: "Ќазвание запуска (например, текст коммита)"
        required: false
        default: ""

jobs:
  build-and-deploy-dev:
    runs-on: [self-hosted, spothub-1]

    env:
      IMAGE_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/full-mvp-backend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Docker login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Compute image tag
        id: vars
        run: |
          SHA="${GITHUB_SHA}"
          echo "Using SHA: ${SHA}"
          echo "tag=dev-${SHA}" >> "$GITHUB_OUTPUT"

      - name: Build backend image
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          IMAGE="${IMAGE_REPO}:${TAG}"
          echo "Building image ${IMAGE}..."
          # если Dockerfile бэкенда лежит не в ./backend Ц поправь путь
          docker build -t "${IMAGE}" ./backend

      - name: Push backend image
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          IMAGE="${IMAGE_REPO}:${TAG}"
          echo "Pushing image ${IMAGE}..."
          docker push "${IMAGE}"

      - name: Deploy backend to DEV namespace
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          IMAGE="${IMAGE_REPO}:${TAG}"
          echo "Deploying ${IMAGE} to sporthub-dev..."
          kubectl -n sporthub-dev set image deployment/sporthub-backend backend="${IMAGE}"
          kubectl -n sporthub-dev rollout status deployment/sporthub-backend
