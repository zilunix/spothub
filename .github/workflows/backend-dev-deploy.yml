name: Deploy Backend to Dev

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Tag образа для DEV (обычно dev-latest или SHA коммита)'
        required: false
        default: 'dev-latest'

jobs:
  deploy-dev:
    runs-on: [self-hosted, spothub-1]

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      IMAGE_TAG: ${{ github.event.inputs.image_tag }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy backend to DEV namespace
        run: |
          TAG="${IMAGE_TAG:-dev-latest}"
          IMAGE="${DOCKERHUB_USERNAME}/full-mvp-backend:${TAG}"
          echo "Deploying image to DEV: $IMAGE"
          kubectl set image deployment/sporthub-backend backend=$IMAGE -n sporthub-dev
          kubectl rollout status deployment/sporthub-backend -n sporthub-dev
