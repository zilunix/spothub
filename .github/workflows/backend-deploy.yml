
name: Backend Deploy (dev/prod)

on:
  workflow_run:
    workflows: [ "Backend CI (tests, build & push)" ]
    types: [ completed ]
  workflow_dispatch:
    inputs:
      environment:
        description: "dev or prod"
        required: true
        default: "dev"
      sha:
        description: "Commit SHA to deploy (optional)"
        required: false

concurrency:
  group: backend-deploy
  cancel-in-progress: false

jobs:
  prepare:
    name: Decide deploy target
    runs-on: self-hosted
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')
    outputs:
      env: ${{ steps.target.outputs.env }}
      sha: ${{ steps.meta.outputs.sha }}
      version: ${{ steps.ver.outputs.version }}
      image: ${{ steps.img.outputs.image }}
    steps:
      - name: Resolve SHA
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            SHA="${{ github.event.workflow_run.head_sha }}"
          else
            SHA="${{ inputs.sha }}"
          fi

          if [ -z "$SHA" ]; then
            SHA="${{ github.sha }}"
          fi

          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Checkout code at SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.meta.outputs.sha }}

      - name: Read commit message from git
        id: msg
        run: |
          MSG="$(git log -1 --format=%B)"
          echo "message<<__EOF__" >> "$GITHUB_OUTPUT"
          echo "$MSG" >> "$GITHUB_OUTPUT"
          echo "__EOF__" >> "$GITHUB_OUTPUT"
          echo "Commit message:"
          echo "$MSG"

      - name: Read version
        id: ver
        run: |
          VERSION="$(cat backend/VERSION | tr -d ' \n\r\t')"
          if [ -z "$VERSION" ]; then echo "backend/VERSION is empty"; exit 1; fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Resolve image repo
        id: img
        run: |
          echo "image=${{ secrets.DOCKERHUB_USERNAME }}/full-mvp-backend" >> "$GITHUB_OUTPUT"

      - name: Decide target environment
        id: target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          else
            MSG="${{ steps.msg.outputs.message }}"
            LMSG="$(echo "$MSG" | tr '[:upper:]' '[:lower:]')"
            ENV="none"
            echo "$LMSG" | grep -q "deploy:dev"  && ENV="dev"
            echo "$LMSG" | grep -q "deploy:prod" && ENV="prod"
          fi

          echo "env=$ENV" >> "$GITHUB_OUTPUT"
          echo "Chosen env: $ENV"
          echo "SHA: ${{ steps.meta.outputs.sha }}"
          echo "VERSION: ${{ steps.ver.outputs.version }}"

  deploy_dev:
    name: Deploy to DEV
    runs-on: self-hosted
    needs: [ prepare ]
    if: needs.prepare.outputs.env == 'dev'
    steps:
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Deploy
        run: |
          IMAGE="${{ needs.prepare.outputs.image }}"
          SHA="${{ needs.prepare.outputs.sha }}"

          echo "Deploying DEV image: $IMAGE:dev-$SHA"
          kubectl -n sporthub-dev set image deployment/sporthub-backend backend="$IMAGE:dev-$SHA"
          kubectl -n sporthub-dev rollout status deployment/sporthub-backend --timeout=180s

  deploy_prod:
    name: Promote and Deploy to PROD
    runs-on: self-hosted
    needs: [ prepare ]
    if: needs.prepare.outputs.env == 'prod'
    environment: sporthub-prod
    steps:
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Promote images
        run: |
          IMAGE="${{ needs.prepare.outputs.image }}"
          SHA="${{ needs.prepare.outputs.sha }}"
          VERSION="${{ needs.prepare.outputs.version }}"

          echo "Promoting $IMAGE:dev-$SHA -> $IMAGE:prod-v$VERSION"
          docker pull "$IMAGE:dev-$SHA"

          docker tag "$IMAGE:dev-$SHA" "$IMAGE:prod-$SHA"
          docker tag "$IMAGE:dev-$SHA" "$IMAGE:prod-v$VERSION"
          docker tag "$IMAGE:dev-$SHA" "$IMAGE:prod-latest"

          docker push "$IMAGE:prod-$SHA"
          docker push "$IMAGE:prod-v$VERSION"
          docker push "$IMAGE:prod-latest"

      - name: Deploy
        run: |
          IMAGE="${{ needs.prepare.outputs.image }}"
          VERSION="${{ needs.prepare.outputs.version }}"

          echo "Deploying PROD image: $IMAGE:prod-v$VERSION"
          kubectl -n sporthub-prod set image deployment/sporthub-backend backend="$IMAGE:prod-v$VERSION"
          kubectl -n sporthub-prod rollout status deployment/sporthub-backend --timeout=180s

